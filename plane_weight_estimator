import numpy as np
import math

#set up
cruise_LoD = 10.0  #group decide on appropriate L/D from chart (will depend on wetted AR)
cruise_ct = 0.6        #cruise
cruise_speed = 460      #knots (40,000ft at Ma 0.8)
cruise_range = 700     #nm from RFP (700nm combat radius, 1000nm desired)

loiter_LoD = 10.0 
loiter_endurance = 1/3  #hrs (20 min loiter max from RFP)
loiter_ct = 0.6 

dash_LoD = 6.0 
dash_ct = 1.0 
dash_range = 50 #nm
dash_speed = 600 #knots

combat_LoD = 3.5
combat_ct = 1.2         #high trust
combat_endurance = 2/60 #hr (2min, 5 min desired)

tolerance = 1e-6            
max_iterations = 100

#payload
aim_120c = 356 #lb
aim_9x = 188 #lb
mk_83jdam = 985 #lb 
crew = 200 #lb
a2a_payload = 2500 + 6*aim_120c + 2*aim_9x + crew
strike_payload = 2500 + 2*aim_9x + 4*mk_83jdam + crew


# mission segment fuel fractions Wi+1/Wi (from ppt slides)
warmup = 0.99
taxi = 0.99
takeoff = 0.99
climb = 0.96 #pick later, given range is 0.9-0.96
combat = math.exp(-combat_endurance*combat_ct/combat_LoD)
dash_ingress = math.exp(-(dash_range)*dash_ct/(dash_speed*dash_LoD))
dash_egress = math.exp(-(dash_range)*dash_ct/(dash_speed*dash_LoD))
descent = 0.99
landing = 0.995
cruise = math.exp(-(cruise_range)*cruise_ct/(cruise_speed*cruise_LoD)) #possibly split into cruise and ingress/egress
loiter = math.exp(-loiter_endurance*loiter_ct/loiter_LoD)
print(f"\ncombat weight fraction: {combat}")
print(f"dash ingress and egress weight fraction:   {dash_ingress}")
print(f"cruise weight fraction: {cruise}")
print(f"loiter weight fraction: {loiter}")


# Initial guess for TOGW
TOGW_guess = 50000.0   #lb

# mission fuel uses: air to air or strike
air_to_air = warmup*taxi*takeoff*climb*cruise*combat*cruise*descent*loiter*landing 
strike = warmup*taxi*takeoff*climb*cruise*dash_ingress*dash_egress*cruise*descent*loiter*landing 

#set mission type
mission_type = input("\nSelect A for air-to-air or S for strike: ")
while mission_type not in ["A", "a", "S", "s"]:
    mission_type = input("Please choose A or S: ")
if mission_type in ["A", "a"]:
    final_weight_fraction = air_to_air
    fuel_fraction = 1 - final_weight_fraction
    fuel_fraction *= 1.06 #reserve fuel
    payload_weight = a2a_payload
    print(f"\nPayload weight for air-to-air is: {payload_weight} lbs")
    print(f"Fuel fraction for air-to-air is:  {fuel_fraction} lbs")
else:
    final_weight_fraction = strike
    fuel_fraction = 1 - final_weight_fraction
    fuel_fraction *= 1.06 #reserve fuel
    payload_weight = strike_payload
    print(f"\nPayload weight for strike is: {payload_weight} lbs")
    print(f"Fuel fraction for strike is:  {fuel_fraction} lbs")

if fuel_fraction >= 1.0:
    print("Fuel fraction exceeds 1.0. Your mission is not feasible")

# Iteration counter
iteration = 0
error = 1.0

while error > tolerance and iteration < max_iterations:
    iteration += 1

    # estimate empty weight fraction We/W0 using Raymer's method
     #A = 2.34 #from raymer txtbook using fighter jet
     # C = -0.13 #from raymer txtbook
     #empty_weight_fraction = A * (TOGW_guess ** C)
     #empty_weight = empty_weight_fraction * TOGW_guess

    # estimate empty weight using Roskam Mehtod
    A = 0.5091
    B = 0.9505
    empty_weight = 10 ** ((np.log10(TOGW_guess) - A) / B)

    # compute weights
    #empty_weight = empty_weight_fraction * TOGW_guess #raymer only
    fuel_weight = fuel_fraction * TOGW_guess

    # solve for new TOGW
    TOGW_new = empty_weight + fuel_weight + payload_weight

    # error
    error = abs(TOGW_new - TOGW_guess) / TOGW_guess

    # update
    TOGW_guess = TOGW_new

# Final result
if error > tolerance:
    print("\nTOGW not converged")
    print(f"Unconvered TOGW: {round(TOGW_guess)}lb")
else:
    print(f"\nConverged TOGW: {round(TOGW_guess)}lb")
    print(f"Converged Empty Weight: {round(empty_weight)}lb")
    print("Iterations:", iteration)

